---
title: "Survey II - Final"
author: "Phong, Marvin, Isabel"
date: "2025-03-01"
output: html_document
---

# Libraries

```{r}
library(tidyverse)
library(readxl)
library(ggplot2)
```

# Cross-country Difference Analysis

Objectives:

-   Analyze the data to understand why support for transgender individuals obtaining official documents varies significantly between countries

-   Individual-level indicators complemented with country-level factors (e.g., cultural norms, legal frameworks. historical context, economic variables, societal attitudes towards LGBTI+ rights)

## Context

```{r}
data <- read_dta("../data/raw/ZA7575.dta")

# Mapping
country_mapping <- data.frame(
  country_name = c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", 
                   "Czech Republic", "Denmark", "Estonia", "Finland", "France", 
                   "Germany", "Greece", "Hungary", "Ireland", "Italy", 
                   "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", 
                   "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", 
                   "Spain", "Sweden", "United Kingdom"),
  iso2 = c("AT", "BE", "BG", "HR", "CY", 
           "CZ", "DK", "EE", "FI", "FR", 
           "DE", "EL", "HU", "IE", "IT", # GR = EL in the survey
           "LV", "LT", "LU", "MT", "NL", 
           "PL", "PT", "RO", "SK", "SI", 
           "ES", "SE", "UK"), # GB = UK in the survey
  country_code = 1:28,  
  stringsAsFactors = FALSE)

# QC19
qc19 <- data %>% 
  mutate(isocntry = ifelse(isocntry %in% c("DE-E", "DE-W"), "DE", isocntry)) %>% 
  select(starts_with("qc19")|"isocntry") %>% 
  group_by(isocntry, qc19) %>% 
  summarise(support = n()) %>% 
  group_by(isocntry) %>% 
  mutate(support_pcg = support/sum(support)) %>% 
  filter(qc19 == 1) 
```

```{r}
# rb_cat <- read_csv(file = "../data/2024-rainbow-map-data.csv", n_max = 2) %>% 
#   select(-1,-2,-3) %>% 
#   t(.) %>% 
#   as.data.frame() %>% 
#   rownames_to_column(var = "category") %>% 
#   rename("criteria" = 2,
#          "ranking_point" = 3) %>% 
#   mutate(category = gsub("\\.\\.\\.\\d+", "", category),
#          ranking_point = parse_number(gsub(",", ".", ranking_point))) 
#   # separate(criteria, into = c("criteria", "group"), sep = "\\(") %>% 
#   # mutate(group = gsub("\\)", "", group)) %>% 
#   # mutate(group = ifelse(is.na(group), "General", group))
# 
# rb_data <- read_csv(file = "../data/2024-rainbow-map-data.csv", skip = 1) %>% 
#   rename("country_code" = 1,
#          "country" = 2,
#          "ranking" = 3) %>% 
#   drop_na(country) %>% 
#   mutate(ranking = ranking/100)

```

```{r}
happiness <- read_rds("../happiness_scores.rds")
```

```{r}
summary(happiness)
sd(happiness$Happiness_Score)
```

The World Happiness reported for 2015-2017, there was a 4-point gap between the top-ranked and bottom-ranked countries. For European countries, this range is lower, down to roughly 2.6 points between the lowest and highest score.

Most countries' scores are within 5.8 and 6.9 and have a standard deviation of 0.744. This indicates a moderate difference in happiness between the countries.

```{r}
ggplot(happiness, aes(x=reorder(Country, Happiness_Score, decreasing = TRUE), y=Happiness_Score)) +
  geom_col() +
  xlab("Country") +
  labs(
    title = "Happiness Score Ranking Among European Countries") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
qc19_ranking <- data.frame(
  country = c("ES", "MT", "NL", "DK", "LU", "FR", "PT", "BE", "DE", "SE", "FI", "UK", "IE", "AT", "EL", "EE", "SI", "IT", "LV", "CY", "PL", "HR", "CZ", "LT", "SK", "RO", "HU", "BG"),
  ranking = seq.int(28)
) %>% 
  left_join(country_mapping, join_by("country" == "iso2")) %>% 
  select(-c(country,country_code))

compare_happiness <- happiness %>% 
  arrange(desc(Happiness_Score)) %>% 
  mutate(happiness_ranking = row_number()) %>% 
  left_join(qc19_ranking, join_by("Country" == "country_name")) %>% 
  rename(support_ranking = ranking) %>% 
  select(Country, happiness_ranking, support_ranking)

compare_happiness
```

```{r}
cor(compare_happiness$happiness_ranking, compare_happiness$support_ranking)
```

```{r}
ggplot(compare_happiness, aes(x = support_ranking, y = happiness_ranking)) +
  geom_point() + 
  geom_smooth( method = "lm")
```

# Predictive Model

Objectives:

-   Develop a predictive model using ML techniques to forecast support levels based on observed trends

-   Ensure model's accuracy and reliability, rigorous calibration, and validation.

## Relevant Features

## Modeling Method

## Model Training

## Model Performance Evaluation
